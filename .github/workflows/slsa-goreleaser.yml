name: SLSA go releaser
on: [push]
permissions: read-all
jobs:
  # Trusted builder.
  build:
    permissions:
      id-token: write # To sign the provenance.
      contents: write # To upload assets to release.
      actions: read # To read the workflow path.
    uses: slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@0779f7bec68e2bf54a7b0a32bf4763f25ab29702 # ratchet:slsa-framework/slsa-github-generator/.github/workflows/builder_go_slsa3.yml@v1.6.0
    with:
      go-version: "1.20"
      # Trusted verifier.
  verify:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # ratchet:actions/checkout@v3
      - uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # ratchet:actions/download-artifact@v3
        with:
          name: ${{ needs.build.outputs.go-provenance-name }}
      - uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # ratchet:actions/download-artifact@v3
        with:
          name: ${{ needs.build.outputs.go-binary-name }}
      - name: Install verifier
        uses: slsa-framework/slsa-verifier/actions/installer@c9abffe4d2ab2ffa0b2ea9b2582b84164f390adc # ratchet:slsa-framework/slsa-verifier/actions/installer@v2.3.0
      - name: Verify
        run: |
          slsa-verifier verify-artifact --provenance-path ${{ needs.build.outputs.go-provenance-name }} \
          --source-uri github.com/${{ github.repository }} ${{ needs.build.outputs.go-binary-name }}